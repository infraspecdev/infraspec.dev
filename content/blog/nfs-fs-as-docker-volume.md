---
title: "Leveraging NFS Filesystem as Volumes in Docker: A Comprehensive Guide"
authorId: "nimisha"
date: 2024-08-19
draft: false
featured: true
weight: 1
---

This article delves into the intricacies of utilizing the NFS (Network File System) as volumes within Docker, offering a comprehensive guide to achieving persistent data storage in containerized environments. Throughout my journey as a DevOps Engineer, I've encountered various scenarios where efficient data management was crucial, particularly when dealing with complex, multi-container applications. In this article, I will share my insights and experiences on effectively leveraging NFS as Docker volumes.
## Overview of Docker Volumes
In containerized environments, the persistent storage of data generated by Docker containers is enabled by Docker volumes. Within the Docker context, a volume is considered a specially designated directory within one or more containers that exists outside the typical Union File System. This means that data stored in volumes is persisted even when the container is stopped or deleted, making volumes indispensable for scenarios where data persistence is required.

## Overview of NFS (Network File System)
NFS, also known as Network File System, is a distributed file system protocol that allows files and directories stored on remote servers to be accessed by clients as if they were local. Operated over a network, NFS provides a shared file system that can be accessed by multiple clients simultaneously. Benefits such as centralized storage management, improved data availability, and seamless file sharing across heterogeneous environments are offered by NFS.

## Understanding Docker Volumes
### Explanation of Docker Volumes and Their Role in Data Persistence:
Docker volumes facilitate the persistent storage of data generated by containers. They serve as dedicated directories within containers, ensuring data persists beyond the container's lifecycle. This ensures data integrity and consistency, critical for various applications and services.
### Types of Docker Volumes:
Docker supports different types of volumes, including named volumes and bind mounts. Named volumes are managed by Docker and provide an easy-to-use interface for persisting data. On the other hand, bind mounts allow specifying a path on the host machine to mount into the container, offering more flexibility in managing data.
### Challenges with Managing Data Persistence:
While Docker volumes offer significant advantages, managing data persistence in containerized environments can present challenges. Issues such as data synchronization, scalability, and resource utilization need to be addressed to ensure efficient data management in Docker-based applications.
### Understanding Network File system(NFS):
NFS is a widely used distributed file system protocol designed for remote file access over a network. Files and directories stored on remote servers can be accessed by clients as if they were local. The protocol operates on client-server architecture, where servers export directories for clients to mount and access. This facilitates seamless file sharing and collaboration across different systems and platforms.
### Advantages of NFS for Sharing and Managing Files:
Centralized storage management is provided, enabling administrators to store and manage files in a single location, simplifying data management and reducing complexity. Efficient data sharing is facilitated, allowing multiple clients to access the same files simultaneously, promoting collaboration and productivity.
Utilizing NFS Volumes in Docker

## Prerequisites:
-   NFS server installed
-   Docker and Docker-compose installed




## Setting Up the NFS Server:
```bash
#!/bin/bash

# Step 1: Create a directory for NFS
NFS_DIR="/srv/nfs"
echo "Creating NFS directory at $NFS_DIR..."
sudo mkdir -p $NFS_DIR

# Step 2: Add export entry to /etc/exports
EXPORTS_ENTRY="$NFS_DIR *(rw,sync,no_subtree_check)"
echo "Adding the following entry to /etc/exports:"
echo "$EXPORTS_ENTRY"
echo "$EXPORTS_ENTRY" | sudo tee -a /etc/exports

# Step 3: Grant necessary permissions to the NFS directory
echo "Setting permissions for $NFS_DIR..."
sudo chmod 755 -R $NFS_DIR

# Step 4: Restart NFS service to apply changes
echo "Restarting NFS service..."
sudo exportfs -ra
sudo systemctl restart nfs-kernel-server

echo "NFS server setup complete!"
```

### Step 1:
This step creates a directory at /srv/nfs where the NFS server will store the shared files. The -p flag ensures that the directory is created along with any necessary parent directories. This directory will be shared with NFS clients.
### Step 2:
The script then adds an entry to the /etc/exports file, which is the configuration file for NFS exports. This entry specifies that the directory /srv/nfs can be accessed by any client (*), with read-write permissions (rw), and that changes are written synchronously (sync). The no_subtree_check option is used to improve performance by skipping certain security checks.
### Step 3:
This step sets the permissions for the NFS directory to 755, meaning that the owner has full read-write-execute permissions, while others have read and execute permissions. The -R flag ensures that these permissions are applied recursively to all files and subdirectories within /srv/nfs.

### Step 4:
Finally, the script reloads the NFS export configuration using exportfs -ra and restarts the NFS server using systemctl restart nfs-kernel-server. This ensures that the NFS server recognizes the new export configuration and is ready to serve the directory to clients.

## Run the script using the command

```bash
$ chmod +x setup_nfs.sh
```

```bash
$ sudo ./setup_nfs.sh
```

## Creating NFS Docker Volume
```bash
$ docker volume create --driver local --opt type=nfs --opt o=addr=<ip-address-of-nfs-server>,rw --opt device=:/srv/nfs  nfs-volume
```

Output:

<img src="/images/blog/nfs-as-docker-volume/create-volume.png" alt="My Collection" width="100%">

We can verify the volume is create with the following command
```bash
$ docker volume ls
```

**Output:**
<img src="/images/blog/nfs-as-docker-volume/docker-vol-ls.png" alt="My Collection" width="100%">

## Mount NFS in a Container
Use the docker run command to start the container. Specify the NFS volume and the mount point in the --mount section.
docker run --name nfs_mounted_node_container --mount source=nfs-volume,target=/opt node

**Output:**
<img src="/images/blog/nfs-as-docker-volume/docker-run.png" alt="My Collection" width="100%">

To verify, we can use the following command with docker exec:

```bash
$ docker exec -it nfs_mounted_node_container sh
```

```bash
$ mount | grep /opt
```

It will display something similar to this
<img src="/images/blog/nfs-as-docker-volume/result.png" alt="My Collection" width="100%">


## Mounting NFS Volumes with Docker Compose

### Create a docker-compose file

```bash
$ nano docker-compose.yml
```

Write the following contents inside the Docker Compose file.
```text
version: '3.8'

services:
  mongo:
	image: mongo
	container_name: nfs_mounted_container
	volumes:
  	- mongo_data:/data/db

volumes:
  mongo_data:
	driver_opts:
  	type: nfs4
  	o: addr=<ip-address-of-nfs-server>,rw
  	device: ":/srv/nfs"
```

## Benefits of using NFS for persistent volumes:

1.  **Centralized Storage Management:** NFS provides a centralized storage solution where files and directories are stored on remote servers. This centralized approach simplifies storage management as administrators can manage and maintain data from a single location.
2.  **Scalability:** NFS allows for seamless scaling of storage capacity by adding more NFS servers or expanding existing ones. This scalability ensures that Docker containers have access to sufficient storage resources as application demands grow.
3. **Improved Data Availability:** With NFS, data stored on remote servers is readily available to Docker containers across the network. This improved availability ensures that applications have continuous access to critical data, minimizing downtime and improving overall reliability.
4. **Seamless File Sharing:** NFS enables seamless file sharing across multiple Docker containers and hosts. Containers can mount NFS volumes and access shared files and directories, facilitating collaboration and data sharing among different parts of the application.
5. **Data Consistency and Reliability:** NFS ensures data consistency and reliability by maintaining a single version of truth for files and directories stored on remote servers. This reliability ensures that Docker containers retrieve accurate and up-to-date information from NFS volumes, enhancing application stability.
6. **Compatibility and Interoperability:** NFS is supported by a wide range of operating systems and platforms, making it highly compatible and interoperable with various Docker environments. This compatibility allows Docker containers running on different systems to access NFS volumes seamlessly.

## Conclusion:

In short, using NFS with Docker offers many benefits, it helps manage storage in one place, scales easily, ensures data is always available, allows easy file sharing, maintains data accuracy, and works well with different systems. Overall, it boosts application performance and reliability by handling data efficiently across different setups. This makes it a strong choice for managing data effectively in modern applications.


## Question:

Have you tried using NFS with Docker yet? If you have, what did you like, and what didn't you like?
